#!/bin/bash
# Make this system headless or not headless



behead_help() {
    echo 'Usage: behead <cmd>'
    echo
    echo 'Make this system headless or not headless.'
    echo
    echo -n 'This script modifies the GRUB_CMDLINE_LINUX_DEFAULT and '
    echo 'GRUB_TERMINAL'
    echo 'variables in /etc/default/grub, then runs `systemctl set-default` in'
    echo 'order to either make this system "headless" or not.'
    echo
    echo 'Commands:'
    echo '  y[es]  Make the necessary changes to boot directly to the console'
    echo '  n[o]   Make the necessary changes to boot to the GUI'
    exit 0
}



behead_err() {
    [[ "$1" == help ]] &&
        behead_help >&2

    echo "behead: $1" >&2
    exit 1
}



behead_reboot() {
    local response
    read -rp 'Would you like to reboot now (yes/no)? ' response

    [[ "$response" =~ ^[Yy]([Ee][Ss])?$ ]] &&
        sudo reboot
}



behead_yes() {
    sudo sed -ri 's/^(GRUB_CMDLINE_LINUX_DEFAULT=).*$/\1"text"/' \
        /etc/default/grub
    sudo sed -ri 's/^#(GRUB_TERMINAL=.*)$/\1/' \
        /etc/default/grub

    sudo update-grub 2>/dev/null
    sudo systemctl set-default multi-user.target 2>/dev/null

    behead_reboot
}



behead_no() {
    sudo sed -ri 's/^(GRUB_CMDLINE_LINUX_DEFAULT=).*$/\1"quiet splash"/' \
        /etc/default/grub
    sudo sed -ri 's/^(GRUB_TERMINAL=.*)$/#\1/' \
        /etc/default/grub

    sudo update-grub 2>/dev/null
    sudo systemctl set-default graphical.target 2>/dev/null

    behead_reboot
}



behead() {
    [[ $# == 0 ]] &&
        behead_err help

    # Parse arguments
    local help yes no
    while (( $# > 0 )); do
        case "$1" in
            -h|--help)
                help=1 ;;
            y|yes)
                yes=1 ;;
            n|no)
                no=1 ;;
            *)
                behead_err "argument not recognized: $1"
        esac
        shift
    done

    [[ $help == 1 ]] &&
        behead_help

    [[ $yes == 1 && $no == 1 ]] &&
        behead_err help

    # Only continue if the sudo password gets cached
    sudo echo >/dev/null || exit 1

    [[ $yes == 1 ]] &&
        behead_yes

    [[ $no == 1 ]] &&
        behead_no
}



behead "$@"
